<!DOCTYPE html>
<head>
	<meta charset="UTF-8">
    <meta name="description" content="Render csv/tsv files (provided either locally or using html arguments) into HTML DataTable using jquery and bootstrap." />
    <title>CSV to Responsive DataTable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.bootstrap4.min.css">
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        padding-left: 5%;
        padding-right: 5%;
      }
      #tableTitle {
        color: gray;
        padding-top: 50px;
        font-size: x-large;
      }
      #tableContainer {display: none}
      #loaderContainer{
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
      }
      div.dataTables_wrapper {
        min-width: 800px;
        margin: 0 auto;
      }
    </style>
</head>
<body>
  <h1 id="tableTitle">tableTitle</h1>
  <hr>
  <div id="tableContainer" class="m-5"></div>
  <div id="loaderContainer">
    <div class="d-flex justify-content-center text-secondary" id="loader">
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Scripts are placed here to help with page loading faster -->
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
  <script type="text/javascript">
    /***********************
    Script sections:
      1- Read URL Arguments
      2- CSV to Array
      3- Array to HTML
    ************************/

    /************************ 
    1- Read URL Argument(s) 
    ************************/
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    var table_name = urlParams.get('table_name') || 'data/tab_separated_table.tsv';
    var table_title = urlParams.get('table_title') || table_name;
    var separator = urlParams.get('separator') || '\t';
    var paging = urlParams.get('paging') || true;
    if (paging === '0' || paging === 'false') {
      var paging = false;
    } else {
      var paging = true;
    }

    /************************ 
    2- CSV to Array 
    ************************/
    function CSVToArray(strData, strDelimiter){
      // CSVToArray Source: https://www.bennadel.com/blog/1504-ask-ben-parsing-csv-strings-with-javascript-exec-regular-expression-command.htm
      // This will parse a delimited string into an array of
      // arrays. The default delimiter is the comma, but this
      // can be overriden in the second argument.
      // Check to see if the delimiter is defined. If not,
      // then default to tab.
      strDelimiter = (strDelimiter || "\t");
      // Create a regular expression to parse the CSV values.
      var objPattern = new RegExp(
        (
          // Delimiters.
          "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
          // Quoted fields.
          "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
          // Standard fields.
          "([^\"\\" + strDelimiter + "\\r\\n]*))"
        ),
        "gi"
        );
      // Create an array to hold our data. Give the array
      // a default empty first row.
      var arrData = [[]];
      // Create an array to hold our individual pattern
      // matching groups.
      var arrMatches = null;
      // Keep looping over the regular expression matches
      // until we can no longer find a match.
      while (arrMatches = objPattern.exec( strData )){
        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];
        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
          strMatchedDelimiter.length &&
          (strMatchedDelimiter != strDelimiter)
          ){
          // Since we have reached a new row of data,
          // add an empty row to our data array.
          arrData.push( [] );
        }
        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (arrMatches[ 2 ]){
          // We found a quoted value. When we capture
          // this value, unescape any double quotes.
          var strMatchedValue = arrMatches[ 2 ].replace(
            new RegExp( "\"\"", "g" ),
            "\""
            );
        } else {
          // We found a non-quoted value.
          var strMatchedValue = arrMatches[ 3 ];
        }
        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
      }
      // Return the parsed data.
      return( arrData );
    }

    /************************ 
    3- Array to HTML
    ************************/
    $("#tableTitle").text(table_title);
    var $table = $('<table id="example" class="display nowrap table table-striped dt-responsive" style="width:100%">');
    var $tableContainer = $("#tableContainer");
    $tableContainer.empty().append($table);

    $.get(table_name).then(
      function (data) {
        var tableData = CSVToArray(data, separator); 
        var $tableHtmlHead = $("<thead></thead>");
        var tableDataHeaderRow = tableData[0];
        var $tableHtmlHeadRow = $("<tr></tr>");

        for (var headerIdx = 0; headerIdx < tableDataHeaderRow.length; headerIdx++) {
          $tableHtmlHeadRow.append($("<th></th>").text(tableDataHeaderRow[headerIdx]));
        }

        $tableHtmlHead.append($tableHtmlHeadRow);
        $table.append($tableHtmlHead);
        var $tableHtmlBody = $("<tbody></tbody>");

        var numColumns = tableDataHeaderRow.length;

        for (var rowIdx = 1; rowIdx < tableData.length; rowIdx++) {
          var $tableHtmlBodyRow = $("<tr></tr>");
          if (tableData[rowIdx].length === numColumns) {
            for (var colIdx = 0; colIdx < tableData[rowIdx].length; colIdx++) {
              var $tableHtmlBodyRowTd = $("<td></td>");
              $tableHtmlBodyRowTd.text(tableData[rowIdx][colIdx]);
              $tableHtmlBodyRow.append($tableHtmlBodyRowTd);
              $tableHtmlBody.append($tableHtmlBodyRow);
            }
          }
        }

        $table.append($tableHtmlBody);
        $tableContainer.append("<p><a class='btn btn-info' href='" + table_name + "'>Download Table</a></p>");

        $table.on('draw.dt', function () {
        $("#tableContainer").attr("id", "container"); 
        $("#loaderContainer").css("display","none");}).DataTable({
          lengthChange: true,
          "scrollX": true,
          "paging": paging
        }); // End loaderContainer
      } // End Function
    ); // End get table_name then
  </script>
</body>
</html>